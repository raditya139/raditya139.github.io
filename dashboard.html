<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    header {
      background: #007bff;
      color: white;
      padding: 15px;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: space-around;
      background: #fff;
      border-top: 1px solid #ddd;
      position: fixed;
      bottom: 0;
      width: 100%;
    }
    nav button {
      flex: 1;
      padding: 10px;
      border: none;
      background: none;
      font-size: 18px;
    }
    .active {
      background-color: #007bff;
      color: white;
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .show {
      display: block;
    }
    .wallet-section input {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .wallet-section button {
      padding: 10px 15px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
    }
    img.profile-img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
    }
  </style>
</head>
<body>

<header>
  <h2>Selamat Datang</h2>
  <p id="userName"></p>
</header>

<div id="dashboard" class="tab-content show">
  <h3>üìä Dashboard</h3>
  <img id="userImg" class="profile-img" src="" alt="User Image">
  <p>Email: <span id="userEmail"></span></p>
  <p>Plan: <span id="userPlan"></span></p>
</div>

<div id="investasi" class="tab-content">
  <h3>üí∞ Investasi</h3>
  <p>Saldo Investment: <span id="saldoInvestment"></span></p>
  <p>Estimasi Saldo: <span id="estimasiSaldo"></span></p>
  <p>Durasi Investasi: <span id="countdown"></span></p>
</div>

<div id="wallet" class="tab-content">
  <h3>üí≥ Wallet</h3>
  <form id="walletForm" class="wallet-section">
    <label>Bank:</label>
    <input type="text" id="userBank" required />
    <label>Nama Rekening:</label>
    <input type="text" id="userNamaRekening" required />
    <label>Nomor Rekening:</label>
    <input type="text" id="userNomorRekening" required />
    <button type="submit">üíæ Simpan</button>
  </form>
  <p id="walletStatus"></p>
</div>

<nav>
  <button onclick="openTab('dashboard')">üè†</button>
  <button onclick="openTab('investasi')">üìà</button>
  <button onclick="openTab('wallet')">üíº</button>
</nav>

<script>
  const user = JSON.parse(localStorage.getItem('loggedInUser'));
  const sheetURL = 'https://opensheet.elk.sh/13DmMCnOOboYfbo3hx1ubukNcQd2jkcHbNlelsB-wIQc/Sheet1';

  if (!user) {
    window.location.href = 'login.html';
  }

  // Populate Dashboard
  document.getElementById('userName').innerText = user.nama;
  document.getElementById('userEmail').innerText = user.email;
  document.getElementById('userPlan').innerText = user.plan;
  document.getElementById('userImg').src = user.image;

  // Populate Investasi
  document.getElementById('saldoInvestment').innerText = user.saldoInvestment;
  document.getElementById('estimasiSaldo').innerText = user.estimasiSaldo;

  // Countdown
  function updateCountdown() {
    const end = new Date(user.durasi);
    const now = new Date();
    const diff = end - now;
    if (diff <= 0) {
      document.getElementById('countdown').innerText = 'Selesai';
      return;
    }
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((diff / (1000 * 60)) % 60);
    const seconds = Math.floor((diff / 1000) % 60);
    document.getElementById('countdown').innerText = `${days}h ${hours}j ${minutes}m ${seconds}d`;
  }
  setInterval(updateCountdown, 1000);
  updateCountdown();

  // Tab Navigation
  function openTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('show'));
    document.getElementById(tabId).classList.add('show');
  }

  // Populate Wallet Form
  document.getElementById('userBank').value = user.bank || '';
  document.getElementById('userNamaRekening').value = user.namaRekening || '';
  document.getElementById('userNomorRekening').value = user.nomorRekening || '';

  // Handle Wallet Save
  document.getElementById('walletForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const bank = document.getElementById('userBank').value;
    const namaRekening = document.getElementById('userNamaRekening').value;
    const nomorRekening = document.getElementById('userNomorRekening').value;

    try {
      const res = await fetch(sheetURL);
      const data = await res.json();
      const index = data.findIndex(u => u.userID === user.userID);

      if (index === -1) {
        alert('User ID tidak ditemukan.');
        return;
      }

      const rowNumber = index + 2; // +2 untuk header + 0-based index
      const range = `Sheet1!H${rowNumber}:J${rowNumber}`;

      const options = {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer 1e405a100a2ddc80530a60c235338259b5c02023105a9c3a11684ae1a8d4a6c7'
        },
        body: JSON.stringify({
          values: [[bank, namaRekening, nomorRekening]]
        })
      };

      const update = await fetch(`https://api.apico.dev/v1/IZwMqf/13DmMCnOOboYfbo3hx1ubukNcQd2jkcHbNlelsB-wIQc/values/${range}?valueInputOption=USER_ENTERED`, options);
      const result = await update.json();

      document.getElementById('walletStatus').textContent = '‚úÖ Data wallet berhasil disimpan!';
      user.bank = bank;
      user.namaRekening = namaRekening;
      user.nomorRekening = nomorRekening;
      localStorage.setItem('loggedInUser', JSON.stringify(user));
    } catch (err) {
      console.error(err);
      document.getElementById('walletStatus').textContent = '‚ùå Gagal menyimpan data!';
    }
  });
</script>

</body>
</html>